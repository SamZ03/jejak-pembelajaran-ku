const inputNamaKelas = document.getElementById("nama-kelas");
const container = document.getElementsByClassName("container")[0];
let namaKelas = null;
let opsi = null;
function loading1(warna = "#006cb6", tinggi = "50px", lebar = "50px") {
    return `<?xml version="1.0" encoding="utf-8"?>
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="margin: auto; background: transparent; display: block; shape-rendering: auto;" width="${lebar}" height="${tinggi}" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
    <circle cx="50" cy="50" fill="none" stroke="${warna}" stroke-width="10" r="35" stroke-dasharray="164.93361431346415 56.97787143782138">
      <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform>
    </circle>
    <!-- [ldio] generated by https://loading.io/ --></svg>`
}

async function nextPage1(pass = false) {
    namaKelas = inputNamaKelas.value;

    if (namaKelas == "" || undefined) {
        alert("Mohon isi nama kelas");
        return;
    }

    try {
        container.getElementsByClassName("next")[0].innerHTML = loading1("#ffffff", "20px", "20px");
        let result = await fetch("/room-data", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ namaKelas, pass })
        });
        result = await result.text();
        if (result == "User tidak dikenali") {
            container.getElementsByClassName("next")[0].innerHTML = "Selanjutnya";
            alert(result);
            return;
        } else if (result == "nama kelas gagal ditambahkan") {
            container.getElementsByClassName("next")[0].innerHTML = "Selanjutnya";
            alert(result);
            return;
        } else if (result == "Kelas pernah dibuat sebelumnya dan belum digunakan"){
            container.getElementsByClassName("next")[0].innerHTML = "Selanjutnya";
            alert(result);
            return;
        } else {
            container.innerHTML = result;
            try {
                const daftarKelas = document.getElementsByClassName("daftar-kelas")[0];
                daftarKelas.innerHTML = loading1();
                let result = await fetch("/absensi");
                result = await result.text();
                if (result != "Gagal terkoneksi dengan database") {
                    result = JSON.parse(result);
                }
                if (result.length < 1) {
                    daftarKelas.innerHTML = `<span> Belum ada absensi yang pernah dibuat </span>`;
                } else {
                    daftarKelas.innerHTML = "";
                    for (const absen of result) {
                        const div = document.createElement("div");
                        const span = document.createElement("span");
                        span.innerHTML = `| &times;`;
                        div.innerText = absen.namaAbsen;
                        div.addEventListener("click", function() {
                            const opsiNames = document.getElementsByClassName("opsi-name");
                            if (opsiNames.length > 0) {
                                for (const opsiName of opsiNames) {
                                    opsiName.classList.remove("opsi-name");
                                }
                            }
                            div.classList.add("opsi-name");
                            opsi = absen.namaAbsen;
                        });
                        div.appendChild(span);
                        daftarKelas.appendChild(div);
                    }
                }
            } catch (err) {
                console.log(err);
            }
        }
    } catch (err) {
        alert("Data gagal ditambahkan");
        console.log(err);
        return;
    }
}

async function menuBuatAbsensi() {
    try {
        container.innerHTML = loading1();
        let result = await fetch("/buat-absensi");
        result = await result.text();
        container.innerHTML = result;
        const p  = document.getElementsByTagName("p")[0];
        const h2 = document.getElementsByTagName("h2");
        if (role[0] == "Guru") {
            p.innerText = "Silahkan masukan nama-nama Guru  dan Siswa, Termasuk nama anda sendiri";
            h2[0].innerText = "Nama Guru";
            h2[1].innerText = "Nama Siswa";
        }
        const inputNama = document.getElementsByClassName("input-nama");
        for (const input of inputNama) {
            input.addEventListener("keyup", function(e) {
                if (e.keyCode == 13) {
                    const nama = e.target.value;
                    if (nama != "") {
                        tambahkanNama(e.target.parentElement.parentElement, nama);
                    }
                }
            });
        }
        document.getElementById("check1").addEventListener("click", function(e) {
            const nama = e.target.previousSibling.value;
            if (nama != "") {
                tambahkanNama(e.target.parentElement.parentElement, nama);
            }
        });
        document.getElementById("check2").addEventListener("click", function(e) {
            const nama = e.target.previousSibling.value;
            if (nama != "") {
                tambahkanNama(e.target.parentElement.parentElement, nama);
            }
        });
    } catch (err) {
        console.log(err);
    }
}

const tambahkanNama = (daftarKelas, value) => {
    const div = document.createElement("div");
    div.classList.add("nama");
    div.innerHTML = value;
    const span = document.createElement("span");
    span.addEventListener("click", function(e) {
        e.target.parentElement.remove();
    });
    span.innerHTML = `| &times;`
    div.appendChild(span);
    const divInput = daftarKelas.getElementsByClassName("input-div")[0];
    daftarKelas.insertBefore(div, divInput);
    divInput.querySelector("input").value = "";
}

const inputkanNama = async () => {
    const namaAbsen = document.getElementById("nama-absen").value;

    if (namaAbsen == "") {
        alert("Mohon beri nama absensi ini");
        return;
    }

    const listDosenRaw = document.querySelectorAll(".dosen .nama");
    const listMahasiswaRaw = document.querySelectorAll(".mahasiswa .nama");

    const listDosen = [];
    const listMahasiswa = [];

    for (const dosen of listDosenRaw) {
        const nama = (dosen.textContent).split("| ×");
        listDosen.push(nama[0]);
    }
    for (const mahasiswa of listMahasiswaRaw) {
        const nama = (mahasiswa.textContent).split("| ×");
        listMahasiswa.push(nama[0]);
    }

    if (listDosen.length < 1 || listMahasiswa.length < 1) {
        alert("Mohon isi nama dosen dan mahasiswa");
        return;
    }

    try {
        let result = await fetch("/post-absen", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                namaAbsen,
                listDosen,
                listMahasiswa
            })
        });
        result = await result.text();
        if (result == "data dimasukan") {
            nextPage1(true);
        } else {
            throw new Error("data gagal ditambahkan");
        }
    } catch (err) {
        console.log(err);
    }
}

const kelasTanpaAbsen = () => {
    opsi = "tanpa absen";
    nextPage2();
}

const nextPage2 = async () => {
    if (opsi == null) {
        alert("mohon pilih absensi");
        return;
    }
    container.innerHTML = loading1();
    try {
        let result = await fetch(`/link-kelas?opsi=${opsi}&kelas=${namaKelas}`);
        result = await result.text();
        container.innerHTML = result;
    } catch (err) {
        console.log(err);
    }
}

const tutup = () => {
    window.location.href = "/"
}